#!/usr/bin/env bash

# TeleClaude - Run from anywhere
# Usage: teleclaude [command] [options]

TELECLAUDE_HOME="${TELECLAUDE_HOME:-/Users/kyrylokyrykov/Developer/projects/experiments/teleclaude}"
PORT="${TELECLAUDE_PORT:-8765}"
SESSION_NAME=""
CLAUDE_ARGS=""
PASSWORD=""

show_help() {
    echo "TeleClaude - Shared Claude Code Terminal"
    echo ""
    echo "Usage: teleclaude [command] [options] [-- claude_args...]"
    echo ""
    echo "Commands:"
    echo "  start [dir]        Start server and attach to Claude Code (default: current dir)"
    echo "  new [dir]          Create new session on running server (use -s for name)"
    echo "  attach [url]       Attach to running session from terminal"
    echo "  sessions           List all running sessions"
    echo "  stop               Stop the server"
    echo "  status             Show server status"
    echo "  url                Show the ngrok URL"
    echo "  vscode [session]   Open VS Code in browser for a session"
    echo "  vscode-install     Install code-server binary"
    echo ""
    echo "Options:"
    echo "  -s, --session NAME Session name (default: 'default')"
    echo "  -p, --port PORT    Port number (default: 8765)"
    echo "  -P, --password PWD Password protect the server"
    echo "  -h, --help         Show this help"
    echo "  -- [args]          Pass remaining arguments to Claude Code"
    echo ""
    echo "Examples:"
    echo "  teleclaude start                           # Start and attach to Claude"
    echo "  teleclaude start -P secret                 # Start with password protection"
    echo "  teleclaude start -- --resume               # Start with --resume flag"
    echo "  teleclaude start ~/code -- --resume        # Start in dir with --resume"
    echo "  teleclaude new -s api ~/api -- --model sonnet  # New session with model"
    echo "  teleclaude sessions                        # List all sessions"
    echo "  teleclaude attach -s myproject             # Attach to named session"
    echo "  teleclaude vscode                          # Open VS Code for default session"
    echo ""
    echo "Press Ctrl+] to detach from session (server keeps running)"
}

check_venv() {
    if [ ! -d "$TELECLAUDE_HOME/venv" ]; then
        echo "Setting up TeleClaude for first use..."
        python3 -m venv "$TELECLAUDE_HOME/venv"
        source "$TELECLAUDE_HOME/venv/bin/activate"
        pip install -q -r "$TELECLAUDE_HOME/requirements.txt"
    fi
}

# Get auth token for API calls (handles password-protected servers)
get_auth_token() {
    # Check if server requires auth
    local auth_status=$(curl -s "http://localhost:$PORT/api/auth/status" 2>/dev/null)
    local auth_required=$(echo "$auth_status" | python3 -c "import sys,json; print(json.load(sys.stdin).get('auth_required', False))" 2>/dev/null)

    if [ "$auth_required" != "True" ]; then
        echo ""
        return 0
    fi

    # Try to load saved password
    local saved_password=""
    if [ -f "$TELECLAUDE_HOME/.teleclaude.password" ]; then
        saved_password=$(cat "$TELECLAUDE_HOME/.teleclaude.password")
    fi

    if [ -z "$saved_password" ]; then
        echo "Error: Server requires password but none saved. Restart server or provide password." >&2
        return 1
    fi

    # Get token
    local response=$(curl -s -X POST "http://localhost:$PORT/api/auth/login" \
        -H "Content-Type: application/json" \
        -d "{\"password\": \"$saved_password\"}" 2>/dev/null)

    local token=$(echo "$response" | python3 -c "import sys,json; print(json.load(sys.stdin).get('token', ''))" 2>/dev/null)

    if [ -z "$token" ]; then
        echo "Error: Failed to authenticate" >&2
        return 1
    fi

    echo "$token"
}

# Make authenticated API call
api_call() {
    local method="$1"
    local endpoint="$2"
    local data="$3"

    local token=$(get_auth_token)
    if [ $? -ne 0 ]; then
        return 1
    fi

    local auth_header=""
    if [ -n "$token" ]; then
        auth_header="-H \"Cookie: teleclaude_token=$token\""
    fi

    if [ "$method" = "GET" ]; then
        eval curl -s $auth_header "http://localhost:$PORT$endpoint"
    elif [ "$method" = "POST" ]; then
        if [ -n "$data" ]; then
            eval curl -s -X POST $auth_header -H \"Content-Type: application/json\" -d "'$data'" "http://localhost:$PORT$endpoint"
        else
            eval curl -s -X POST $auth_header "http://localhost:$PORT$endpoint"
        fi
    elif [ "$method" = "DELETE" ]; then
        eval curl -s -X DELETE $auth_header "http://localhost:$PORT$endpoint"
    fi
}

cmd_start() {
    local workdir="${1:-$(pwd)}"
    workdir="$(cd "$workdir" && pwd)"  # Get absolute path
    local session="${SESSION_NAME:-default}"

    echo "==================================="
    echo "   TeleClaude - Shared Terminal"
    echo "==================================="
    echo ""
    echo "Session: $session"
    echo "Working directory: $workdir"
    if [ -n "$CLAUDE_ARGS" ]; then
        echo "Claude args: $CLAUDE_ARGS"
    fi
    if [ -n "$PASSWORD" ]; then
        echo "Password: enabled"
    fi
    echo ""

    check_venv
    source "$TELECLAUDE_HOME/venv/bin/activate"

    # Kill any existing processes on this port
    pkill -f "uvicorn server.main:app.*--port $PORT" 2>/dev/null || true
    pkill -f "ngrok http $PORT" 2>/dev/null || true
    sleep 1

    # Start server in background, fully detached from terminal
    cd "$TELECLAUDE_HOME"
    export TELECLAUDE_WORKDIR="$workdir"
    export TELECLAUDE_SESSION="$session"
    export TELECLAUDE_CLAUDE_ARGS="$CLAUDE_ARGS"
    export TELECLAUDE_PASSWORD="$PASSWORD"

    # Save password for CLI commands (if set)
    if [ -n "$PASSWORD" ]; then
        echo "$PASSWORD" > "$TELECLAUDE_HOME/.teleclaude.password"
        chmod 600 "$TELECLAUDE_HOME/.teleclaude.password"
    else
        rm -f "$TELECLAUDE_HOME/.teleclaude.password"
    fi

    # Start server with nohup to survive terminal close
    nohup uvicorn server.main:app --host 0.0.0.0 --port $PORT > "$TELECLAUDE_HOME/.teleclaude.log" 2>&1 &
    SERVER_PID=$!
    disown $SERVER_PID 2>/dev/null || true
    echo $SERVER_PID > "$TELECLAUDE_HOME/.teleclaude.pid"

    # Wait for server to be ready
    echo "Starting server..."
    for i in {1..10}; do
        if curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
            break
        fi
        sleep 0.5
    done

    if ! kill -0 $SERVER_PID 2>/dev/null; then
        echo "Error: Server failed to start"
        echo "Check logs: cat $TELECLAUDE_HOME/.teleclaude.log"
        exit 1
    fi

    echo "Local:  http://localhost:$PORT"

    # Start ngrok if available (also detached)
    if command -v ngrok &> /dev/null; then
        nohup ngrok http $PORT --log=stdout > /dev/null 2>&1 &
        NGROK_PID=$!
        disown $NGROK_PID 2>/dev/null || true
        echo $NGROK_PID > "$TELECLAUDE_HOME/.teleclaude.ngrok.pid"
        sleep 2

        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | python3 -c "import sys, json; data = json.load(sys.stdin); tunnels = data.get('tunnels', []); print(tunnels[0]['public_url'] if tunnels else '')" 2>/dev/null || echo "")

        if [ -n "$NGROK_URL" ]; then
            echo "Remote: $NGROK_URL"
            echo "$NGROK_URL" > "$TELECLAUDE_HOME/.teleclaude.url"
        fi
    else
        echo ""
        echo "Tip: Install ngrok for remote access: brew install ngrok"
    fi

    echo ""
    echo "Press Ctrl+] to detach (server keeps running)"
    echo "Use 'teleclaude stop' to stop server"
    echo ""
    sleep 1

    # Automatically attach to the session
    python -m server.attach --port $PORT --session "$session"

    # After detach, show status
    echo ""
    echo "Detached from session '$session'"
    echo "Server is still running in background"
    echo ""
    echo "  Reattach:  teleclaude attach -s $session"
    echo "  Stop:      teleclaude stop"
    echo "  Status:    teleclaude status"
}

cmd_new() {
    local workdir="${1:-$(pwd)}"
    workdir="$(cd "$workdir" && pwd)"  # Get absolute path
    local session="${SESSION_NAME:-session_$(date +%s)}"

    if ! curl -s "http://localhost:$PORT/api/auth/status" > /dev/null 2>&1; then
        echo "Error: TeleClaude server is not running"
        echo "Start it first with: teleclaude start"
        exit 1
    fi

    echo "Creating new session '$session' in $workdir..."
    if [ -n "$CLAUDE_ARGS" ]; then
        echo "Claude args: $CLAUDE_ARGS"
    fi

    # URL encode the arguments
    local encoded_args=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$CLAUDE_ARGS'))")
    local endpoint="/api/sessions/$session?working_dir=$workdir"
    if [ -n "$CLAUDE_ARGS" ]; then
        endpoint="$endpoint&claude_args=$encoded_args"
    fi

    response=$(api_call POST "$endpoint")

    if [ $? -ne 0 ]; then
        echo "Failed to create session: authentication error"
        exit 1
    fi

    if echo "$response" | grep -q '"status":"created"'; then
        echo "Session '$session' created successfully!"
        echo ""
        echo "Attach to it: teleclaude attach -s $session"
        echo "Or open in browser: http://localhost:$PORT?session=$session"
    else
        echo "Failed to create session: $response"
        exit 1
    fi
}

cmd_attach() {
    local target="$1"
    local session="${SESSION_NAME:-default}"

    check_venv
    source "$TELECLAUDE_HOME/venv/bin/activate"

    cd "$TELECLAUDE_HOME"

    # If URL provided (http/https/ws/wss), connect to remote
    if [[ "$target" =~ ^https?:// ]] || [[ "$target" =~ ^wss?:// ]]; then
        # Convert http(s) to ws(s) if needed
        local ws_url="$target"
        ws_url="${ws_url/https:\/\//wss://}"
        ws_url="${ws_url/http:\/\//ws://}"

        # Add /ws/terminal if not present
        if [[ ! "$ws_url" =~ /ws/terminal ]]; then
            ws_url="${ws_url%/}/ws/terminal?session_id=$session"
        fi

        echo "Attaching to remote session '$session'..."
        echo "Press Ctrl+] to detach (session keeps running)"
        echo ""
        python -m server.attach --url "$ws_url"
    else
        # Local connection
        if ! curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
            echo "Error: TeleClaude server is not running"
            echo "Start it with: teleclaude start"
            exit 1
        fi

        echo "Attaching to session '$session' at localhost:$PORT..."
        echo "Press Ctrl+] to detach (session keeps running)"
        echo ""
        python -m server.attach --port $PORT --session "$session"
    fi
}

cmd_sessions() {
    if ! curl -s "http://localhost:$PORT/api/auth/status" > /dev/null 2>&1; then
        echo "TeleClaude is not running"
        echo "Start it with: teleclaude start"
        exit 1
    fi

    echo "TeleClaude Sessions"
    echo "==================="

    # Get ngrok URL if available
    local ngrok_url=""
    if [ -f "$TELECLAUDE_HOME/.teleclaude.url" ]; then
        ngrok_url=$(cat "$TELECLAUDE_HOME/.teleclaude.url")
    fi

    api_call GET "/api/sessions" | python3 -c "
import sys, json
data = json.load(sys.stdin)
current = data.get('current', 'default')
sessions = data.get('sessions', [])
if not sessions:
    print('  No sessions')
else:
    for s in sessions:
        marker = '*' if s['id'] == current else ' '
        status = 'running' if s['running'] else 'stopped'
        clients = s.get('clients', 0)
        workdir = s.get('working_dir', 'unknown')
        cmd = s.get('command', ['claude'])
        args = ' '.join(cmd[1:]) if len(cmd) > 1 else ''
        line = f\"{marker} {s['id']:15} {status:8} {clients} clients  {workdir}\"
        if args:
            line += f'  [{args}]'
        print(line)
"
    echo ""
    echo "* = current session"
    echo ""
    echo "Local:  http://localhost:$PORT"
    if [ -n "$ngrok_url" ]; then
        echo "Remote: $ngrok_url"
    fi
    echo ""
    echo "Attach to a session: teleclaude attach -s <session_name>"
}

cmd_stop() {
    echo "Stopping TeleClaude..."

    if [ -f "$TELECLAUDE_HOME/.teleclaude.pid" ]; then
        PID=$(cat "$TELECLAUDE_HOME/.teleclaude.pid")
        kill $PID 2>/dev/null && echo "Server stopped"
        rm -f "$TELECLAUDE_HOME/.teleclaude.pid"
    fi

    if [ -f "$TELECLAUDE_HOME/.teleclaude.ngrok.pid" ]; then
        PID=$(cat "$TELECLAUDE_HOME/.teleclaude.ngrok.pid")
        kill $PID 2>/dev/null && echo "ngrok stopped"
        rm -f "$TELECLAUDE_HOME/.teleclaude.ngrok.pid"
    fi

    pkill -f "uvicorn server.main:app.*--port $PORT" 2>/dev/null
    pkill -f "ngrok http $PORT" 2>/dev/null
    rm -f "$TELECLAUDE_HOME/.teleclaude.url"
    rm -f "$TELECLAUDE_HOME/.teleclaude.password"

    echo "Done"
}

cmd_status() {
    if curl -s "http://localhost:$PORT/api/auth/status" > /dev/null 2>&1; then
        echo "TeleClaude is running"
        api_call GET "/api/status" | python3 -c "
import sys, json
data = json.load(sys.stdin)
print(f\"  Current session: {data.get('current_session', 'default')}\")
print(f\"  Working dir: {data.get('working_dir', 'unknown')}\")
print(f\"  Clients: {data.get('connected_clients', 0)}\")
sessions = data.get('sessions', [])
print(f\"  Total sessions: {len(sessions)}\")
print(f\"  Local: http://localhost:$PORT\")
"
        if [ -f "$TELECLAUDE_HOME/.teleclaude.url" ]; then
            echo "  Remote: $(cat "$TELECLAUDE_HOME/.teleclaude.url")"
        fi
    else
        echo "TeleClaude is not running"
        echo "Start it with: teleclaude start"
    fi
}

cmd_url() {
    if [ -f "$TELECLAUDE_HOME/.teleclaude.url" ]; then
        cat "$TELECLAUDE_HOME/.teleclaude.url"
    else
        if curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
            echo "http://localhost:$PORT"
            echo ""
            echo "No ngrok tunnel. Start ngrok for remote access."
        else
            echo "TeleClaude is not running"
        fi
    fi
}

cmd_vscode() {
    local session="${1:-${SESSION_NAME:-default}}"

    if ! curl -s "http://localhost:$PORT/api/auth/status" > /dev/null 2>&1; then
        echo "Error: TeleClaude server is not running"
        echo "Start it first with: teleclaude start"
        exit 1
    fi

    # Check if code-server is installed
    if [ ! -f "$TELECLAUDE_HOME/bin/code-server" ] && ! command -v code-server &> /dev/null; then
        echo "code-server is not installed."
        echo "Install it with: teleclaude vscode-install"
        exit 1
    fi

    echo "Starting VS Code for session '$session'..."

    # Start code-server via API
    response=$(api_call POST "/api/vscode/$session")

    if [ $? -ne 0 ]; then
        echo "Failed to start VS Code: authentication error"
        exit 1
    fi

    if echo "$response" | grep -q '"status":"running"'; then
        # Get the URL
        local base_url="http://localhost:$PORT"
        if [ -f "$TELECLAUDE_HOME/.teleclaude.url" ]; then
            base_url=$(cat "$TELECLAUDE_HOME/.teleclaude.url")
        fi

        local vscode_url="$base_url/vscode/$session/"
        echo "VS Code is ready!"
        echo ""
        echo "URL: $vscode_url"
        echo ""

        # Try to open in browser
        if command -v open &> /dev/null; then
            open "$vscode_url"
        elif command -v xdg-open &> /dev/null; then
            xdg-open "$vscode_url"
        else
            echo "Open this URL in your browser to access VS Code."
        fi
    else
        echo "Failed to start VS Code: $response"
        exit 1
    fi
}

cmd_vscode_install() {
    echo "Installing code-server..."

    # Detect platform and architecture
    local os=""
    local arch=""

    case "$(uname -s)" in
        Darwin) os="macos" ;;
        Linux) os="linux" ;;
        *)
            echo "Unsupported operating system: $(uname -s)"
            exit 1
            ;;
    esac

    case "$(uname -m)" in
        x86_64|amd64) arch="amd64" ;;
        arm64|aarch64) arch="arm64" ;;
        *)
            echo "Unsupported architecture: $(uname -m)"
            exit 1
            ;;
    esac

    echo "Detected: $os-$arch"

    # Get latest version from GitHub API
    echo "Fetching latest version..."
    local version=$(curl -s "https://api.github.com/repos/coder/code-server/releases/latest" | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')

    if [ -z "$version" ]; then
        echo "Failed to get latest version. Using fallback version."
        version="4.96.4"
    fi

    echo "Version: $version"

    # Construct download URL
    local filename="code-server-${version}-${os}-${arch}.tar.gz"
    local url="https://github.com/coder/code-server/releases/download/v${version}/${filename}"

    echo "Downloading from: $url"

    # Create bin directory
    mkdir -p "$TELECLAUDE_HOME/bin"
    local tmp_dir=$(mktemp -d)

    # Download and extract
    if curl -fL "$url" -o "$tmp_dir/$filename"; then
        echo "Extracting..."
        tar -xzf "$tmp_dir/$filename" -C "$tmp_dir"

        # Find and copy the binary
        local extracted_dir="$tmp_dir/code-server-${version}-${os}-${arch}"
        if [ -f "$extracted_dir/bin/code-server" ]; then
            cp "$extracted_dir/bin/code-server" "$TELECLAUDE_HOME/bin/code-server"
            chmod +x "$TELECLAUDE_HOME/bin/code-server"

            # Also copy lib directory if it exists (needed for some versions)
            if [ -d "$extracted_dir/lib" ]; then
                cp -r "$extracted_dir/lib" "$TELECLAUDE_HOME/bin/"
            fi

            echo ""
            echo "code-server installed successfully!"
            echo "Location: $TELECLAUDE_HOME/bin/code-server"
            echo ""
            echo "You can now use: teleclaude vscode"
        else
            echo "Error: Could not find code-server binary in extracted files"
            ls -la "$tmp_dir"
            exit 1
        fi
    else
        echo "Error: Failed to download code-server"
        exit 1
    fi

    # Cleanup
    rm -rf "$tmp_dir"
}

cmd_vscode_stop() {
    local session="${1:-${SESSION_NAME:-default}}"

    if ! curl -s "http://localhost:$PORT/api/auth/status" > /dev/null 2>&1; then
        echo "Error: TeleClaude server is not running"
        exit 1
    fi

    echo "Stopping VS Code for session '$session'..."
    response=$(api_call DELETE "/api/vscode/$session")

    if echo "$response" | grep -q '"status":"stopped"'; then
        echo "VS Code stopped."
    else
        echo "Response: $response"
    fi
}

# Parse arguments
POSITIONAL_ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--session)
            SESSION_NAME="$2"
            shift 2
            ;;
        -p|--port)
            PORT="$2"
            shift 2
            ;;
        -P|--password)
            PASSWORD="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        --)
            shift
            CLAUDE_ARGS="$*"
            break
            ;;
        *)
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

set -- "${POSITIONAL_ARGS[@]}"

case "${1:-start}" in
    start)
        cmd_start "$2"
        ;;
    new|add)
        cmd_new "$2"
        ;;
    attach|a)
        cmd_attach "$2"
        ;;
    sessions|ls)
        cmd_sessions
        ;;
    stop)
        cmd_stop
        ;;
    status|s)
        cmd_status
        ;;
    url|u)
        cmd_url
        ;;
    vscode|code|vs)
        cmd_vscode "$2"
        ;;
    vscode-install|code-install)
        cmd_vscode_install
        ;;
    vscode-stop|code-stop)
        cmd_vscode_stop "$2"
        ;;
    *)
        echo "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
