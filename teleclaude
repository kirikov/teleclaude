#!/usr/bin/env bash

# TeleClaude - Run from anywhere
# Usage: teleclaude [command] [options]

TELECLAUDE_HOME="${TELECLAUDE_HOME:-/Users/kyrylokyrykov/Developer/projects/experiments/teleclaude}"
PORT="${TELECLAUDE_PORT:-8765}"
SESSION_NAME=""
CLAUDE_ARGS=""

show_help() {
    echo "TeleClaude - Shared Claude Code Terminal"
    echo ""
    echo "Usage: teleclaude [command] [options] [-- claude_args...]"
    echo ""
    echo "Commands:"
    echo "  start [dir]        Start server and attach to Claude Code (default: current dir)"
    echo "  new [dir]          Create new session on running server (use -s for name)"
    echo "  attach [url]       Attach to running session from terminal"
    echo "  sessions           List all running sessions"
    echo "  stop               Stop the server"
    echo "  status             Show server status"
    echo "  url                Show the ngrok URL"
    echo ""
    echo "Options:"
    echo "  -s, --session NAME Session name (default: 'default')"
    echo "  -p, --port PORT    Port number (default: 8765)"
    echo "  -h, --help         Show this help"
    echo "  -- [args]          Pass remaining arguments to Claude Code"
    echo ""
    echo "Examples:"
    echo "  teleclaude start                           # Start and attach to Claude"
    echo "  teleclaude start -- --resume               # Start with --resume flag"
    echo "  teleclaude start ~/code -- --resume        # Start in dir with --resume"
    echo "  teleclaude new -s api ~/api -- --model sonnet  # New session with model"
    echo "  teleclaude sessions                        # List all sessions"
    echo "  teleclaude attach -s myproject             # Attach to named session"
    echo ""
    echo "Press Ctrl+] to detach from session (server keeps running)"
}

check_venv() {
    if [ ! -d "$TELECLAUDE_HOME/venv" ]; then
        echo "Setting up TeleClaude for first use..."
        python3 -m venv "$TELECLAUDE_HOME/venv"
        source "$TELECLAUDE_HOME/venv/bin/activate"
        pip install -q -r "$TELECLAUDE_HOME/requirements.txt"
    fi
}

cmd_start() {
    local workdir="${1:-$(pwd)}"
    workdir="$(cd "$workdir" && pwd)"  # Get absolute path
    local session="${SESSION_NAME:-default}"

    echo "==================================="
    echo "   TeleClaude - Shared Terminal"
    echo "==================================="
    echo ""
    echo "Session: $session"
    echo "Working directory: $workdir"
    if [ -n "$CLAUDE_ARGS" ]; then
        echo "Claude args: $CLAUDE_ARGS"
    fi
    echo ""

    check_venv
    source "$TELECLAUDE_HOME/venv/bin/activate"

    # Kill any existing processes on this port
    pkill -f "uvicorn server.main:app.*--port $PORT" 2>/dev/null || true
    pkill -f "ngrok http $PORT" 2>/dev/null || true
    sleep 1

    # Start server in background, fully detached from terminal
    cd "$TELECLAUDE_HOME"
    export TELECLAUDE_WORKDIR="$workdir"
    export TELECLAUDE_SESSION="$session"
    export TELECLAUDE_CLAUDE_ARGS="$CLAUDE_ARGS"

    # Start server with nohup to survive terminal close
    nohup uvicorn server.main:app --host 0.0.0.0 --port $PORT > "$TELECLAUDE_HOME/.teleclaude.log" 2>&1 &
    SERVER_PID=$!
    disown $SERVER_PID 2>/dev/null || true
    echo $SERVER_PID > "$TELECLAUDE_HOME/.teleclaude.pid"

    # Wait for server to be ready
    echo "Starting server..."
    for i in {1..10}; do
        if curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
            break
        fi
        sleep 0.5
    done

    if ! kill -0 $SERVER_PID 2>/dev/null; then
        echo "Error: Server failed to start"
        echo "Check logs: cat $TELECLAUDE_HOME/.teleclaude.log"
        exit 1
    fi

    echo "Local:  http://localhost:$PORT"

    # Start ngrok if available (also detached)
    if command -v ngrok &> /dev/null; then
        nohup ngrok http $PORT --log=stdout > /dev/null 2>&1 &
        NGROK_PID=$!
        disown $NGROK_PID 2>/dev/null || true
        echo $NGROK_PID > "$TELECLAUDE_HOME/.teleclaude.ngrok.pid"
        sleep 2

        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | python3 -c "import sys, json; data = json.load(sys.stdin); tunnels = data.get('tunnels', []); print(tunnels[0]['public_url'] if tunnels else '')" 2>/dev/null || echo "")

        if [ -n "$NGROK_URL" ]; then
            echo "Remote: $NGROK_URL"
            echo "$NGROK_URL" > "$TELECLAUDE_HOME/.teleclaude.url"
        fi
    else
        echo ""
        echo "Tip: Install ngrok for remote access: brew install ngrok"
    fi

    echo ""
    echo "Press Ctrl+] to detach (server keeps running)"
    echo "Use 'teleclaude stop' to stop server"
    echo ""
    sleep 1

    # Automatically attach to the session
    python -m server.attach --port $PORT --session "$session"

    # After detach, show status
    echo ""
    echo "Detached from session '$session'"
    echo "Server is still running in background"
    echo ""
    echo "  Reattach:  teleclaude attach -s $session"
    echo "  Stop:      teleclaude stop"
    echo "  Status:    teleclaude status"
}

cmd_new() {
    local workdir="${1:-$(pwd)}"
    workdir="$(cd "$workdir" && pwd)"  # Get absolute path
    local session="${SESSION_NAME:-session_$(date +%s)}"

    if ! curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
        echo "Error: TeleClaude server is not running"
        echo "Start it first with: teleclaude start"
        exit 1
    fi

    echo "Creating new session '$session' in $workdir..."
    if [ -n "$CLAUDE_ARGS" ]; then
        echo "Claude args: $CLAUDE_ARGS"
    fi

    # URL encode the arguments
    local encoded_args=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$CLAUDE_ARGS'))")
    local url="http://localhost:$PORT/api/sessions/$session?working_dir=$workdir"
    if [ -n "$CLAUDE_ARGS" ]; then
        url="$url&claude_args=$encoded_args"
    fi

    response=$(curl -s -X POST "$url")

    if echo "$response" | grep -q '"status":"created"'; then
        echo "Session '$session' created successfully!"
        echo ""
        echo "Attach to it: teleclaude attach -s $session"
        echo "Or open in browser: http://localhost:$PORT?session=$session"
    else
        echo "Failed to create session: $response"
        exit 1
    fi
}

cmd_attach() {
    local target="$1"
    local session="${SESSION_NAME:-default}"

    check_venv
    source "$TELECLAUDE_HOME/venv/bin/activate"

    cd "$TELECLAUDE_HOME"

    # If URL provided (http/https/ws/wss), connect to remote
    if [[ "$target" =~ ^https?:// ]] || [[ "$target" =~ ^wss?:// ]]; then
        # Convert http(s) to ws(s) if needed
        local ws_url="$target"
        ws_url="${ws_url/https:\/\//wss://}"
        ws_url="${ws_url/http:\/\//ws://}"

        # Add /ws/terminal if not present
        if [[ ! "$ws_url" =~ /ws/terminal ]]; then
            ws_url="${ws_url%/}/ws/terminal?session_id=$session"
        fi

        echo "Attaching to remote session '$session'..."
        echo "Press Ctrl+] to detach (session keeps running)"
        echo ""
        python -m server.attach --url "$ws_url"
    else
        # Local connection
        if ! curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
            echo "Error: TeleClaude server is not running"
            echo "Start it with: teleclaude start"
            exit 1
        fi

        echo "Attaching to session '$session' at localhost:$PORT..."
        echo "Press Ctrl+] to detach (session keeps running)"
        echo ""
        python -m server.attach --port $PORT --session "$session"
    fi
}

cmd_sessions() {
    if ! curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
        echo "TeleClaude is not running"
        echo "Start it with: teleclaude start"
        exit 1
    fi

    echo "TeleClaude Sessions"
    echo "==================="

    # Get ngrok URL if available
    local ngrok_url=""
    if [ -f "$TELECLAUDE_HOME/.teleclaude.url" ]; then
        ngrok_url=$(cat "$TELECLAUDE_HOME/.teleclaude.url")
    fi

    curl -s "http://localhost:$PORT/api/sessions" | python3 -c "
import sys, json
data = json.load(sys.stdin)
current = data.get('current', 'default')
sessions = data.get('sessions', [])
if not sessions:
    print('  No sessions')
else:
    for s in sessions:
        marker = '*' if s['id'] == current else ' '
        status = 'running' if s['running'] else 'stopped'
        clients = s.get('clients', 0)
        workdir = s.get('working_dir', 'unknown')
        cmd = s.get('command', ['claude'])
        args = ' '.join(cmd[1:]) if len(cmd) > 1 else ''
        line = f\"{marker} {s['id']:15} {status:8} {clients} clients  {workdir}\"
        if args:
            line += f'  [{args}]'
        print(line)
"
    echo ""
    echo "* = current session"
    echo ""
    echo "Local:  http://localhost:$PORT"
    if [ -n "$ngrok_url" ]; then
        echo "Remote: $ngrok_url"
    fi
    echo ""
    echo "Attach to a session: teleclaude attach -s <session_name>"
}

cmd_stop() {
    echo "Stopping TeleClaude..."

    if [ -f "$TELECLAUDE_HOME/.teleclaude.pid" ]; then
        PID=$(cat "$TELECLAUDE_HOME/.teleclaude.pid")
        kill $PID 2>/dev/null && echo "Server stopped"
        rm -f "$TELECLAUDE_HOME/.teleclaude.pid"
    fi

    if [ -f "$TELECLAUDE_HOME/.teleclaude.ngrok.pid" ]; then
        PID=$(cat "$TELECLAUDE_HOME/.teleclaude.ngrok.pid")
        kill $PID 2>/dev/null && echo "ngrok stopped"
        rm -f "$TELECLAUDE_HOME/.teleclaude.ngrok.pid"
    fi

    pkill -f "uvicorn server.main:app.*--port $PORT" 2>/dev/null
    pkill -f "ngrok http $PORT" 2>/dev/null
    rm -f "$TELECLAUDE_HOME/.teleclaude.url"

    echo "Done"
}

cmd_status() {
    if curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
        echo "TeleClaude is running"
        curl -s "http://localhost:$PORT/api/status" | python3 -c "
import sys, json
data = json.load(sys.stdin)
print(f\"  Current session: {data.get('current_session', 'default')}\")
print(f\"  Working dir: {data.get('working_dir', 'unknown')}\")
print(f\"  Clients: {data.get('connected_clients', 0)}\")
sessions = data.get('sessions', [])
print(f\"  Total sessions: {len(sessions)}\")
print(f\"  Local: http://localhost:$PORT\")
"
        if [ -f "$TELECLAUDE_HOME/.teleclaude.url" ]; then
            echo "  Remote: $(cat "$TELECLAUDE_HOME/.teleclaude.url")"
        fi
    else
        echo "TeleClaude is not running"
        echo "Start it with: teleclaude start"
    fi
}

cmd_url() {
    if [ -f "$TELECLAUDE_HOME/.teleclaude.url" ]; then
        cat "$TELECLAUDE_HOME/.teleclaude.url"
    else
        if curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
            echo "http://localhost:$PORT"
            echo ""
            echo "No ngrok tunnel. Start ngrok for remote access."
        else
            echo "TeleClaude is not running"
        fi
    fi
}

# Parse arguments
POSITIONAL_ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--session)
            SESSION_NAME="$2"
            shift 2
            ;;
        -p|--port)
            PORT="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        --)
            shift
            CLAUDE_ARGS="$*"
            break
            ;;
        *)
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

set -- "${POSITIONAL_ARGS[@]}"

case "${1:-start}" in
    start)
        cmd_start "$2"
        ;;
    new|add)
        cmd_new "$2"
        ;;
    attach|a)
        cmd_attach "$2"
        ;;
    sessions|ls)
        cmd_sessions
        ;;
    stop)
        cmd_stop
        ;;
    status|s)
        cmd_status
        ;;
    url|u)
        cmd_url
        ;;
    *)
        echo "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
