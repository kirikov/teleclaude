#!/usr/bin/env bash

# TeleClaude - Run from anywhere
# Usage: teleclaude [command] [options]

TELECLAUDE_HOME="${TELECLAUDE_HOME:-/Users/kyrylokyrykov/Developer/projects/experiments/teleclaude}"
PORT="${TELECLAUDE_PORT:-8765}"

show_help() {
    echo "TeleClaude - Shared Claude Code Terminal"
    echo ""
    echo "Usage: teleclaude [command] [options]"
    echo ""
    echo "Commands:"
    echo "  start [dir]    Start server with Claude Code in [dir] (default: current dir)"
    echo "  attach [url]   Attach to running session from terminal"
    echo "  stop           Stop the server"
    echo "  status         Show server status"
    echo "  url            Show the ngrok URL"
    echo ""
    echo "Options:"
    echo "  -p, --port     Port number (default: 8765)"
    echo "  -h, --help     Show this help"
    echo ""
    echo "Examples:"
    echo "  teleclaude start                        # Start in current directory"
    echo "  teleclaude start ~/myproject            # Start in specific directory"
    echo "  teleclaude attach                       # Attach to local session"
    echo "  teleclaude attach https://abc123.ngrok.io  # Attach to remote session"
    echo "  teleclaude url                          # Get URL to share"
}

check_venv() {
    if [ ! -d "$TELECLAUDE_HOME/venv" ]; then
        echo "Setting up TeleClaude for first use..."
        python3 -m venv "$TELECLAUDE_HOME/venv"
        source "$TELECLAUDE_HOME/venv/bin/activate"
        pip install -q -r "$TELECLAUDE_HOME/requirements.txt"
    fi
}

cmd_start() {
    local workdir="${1:-$(pwd)}"
    workdir="$(cd "$workdir" && pwd)"  # Get absolute path

    echo "==================================="
    echo "   TeleClaude - Shared Terminal"
    echo "==================================="
    echo ""
    echo "Working directory: $workdir"
    echo ""

    check_venv
    source "$TELECLAUDE_HOME/venv/bin/activate"

    # Kill any existing processes
    pkill -f "uvicorn server.main:app.*--port $PORT" 2>/dev/null || true
    pkill -f "ngrok http $PORT" 2>/dev/null || true
    sleep 1

    # Start server
    cd "$TELECLAUDE_HOME"
    export TELECLAUDE_WORKDIR="$workdir"
    uvicorn server.main:app --host 0.0.0.0 --port $PORT &
    SERVER_PID=$!
    echo $SERVER_PID > "$TELECLAUDE_HOME/.teleclaude.pid"

    sleep 2

    if ! kill -0 $SERVER_PID 2>/dev/null; then
        echo "Error: Server failed to start"
        exit 1
    fi

    echo "Local:  http://localhost:$PORT"

    # Start ngrok if available
    if command -v ngrok &> /dev/null; then
        ngrok http $PORT --log=stdout > /dev/null &
        NGROK_PID=$!
        sleep 3

        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | python3 -c "import sys, json; data = json.load(sys.stdin); tunnels = data.get('tunnels', []); print(tunnels[0]['public_url'] if tunnels else '')" 2>/dev/null || echo "")

        if [ -n "$NGROK_URL" ]; then
            echo "Remote: $NGROK_URL"
            echo "$NGROK_URL" > "$TELECLAUDE_HOME/.teleclaude.url"
        fi
    else
        echo ""
        echo "Tip: Install ngrok for remote access: brew install ngrok"
    fi

    echo ""
    echo "Attach from another terminal: teleclaude attach"
    echo "  (use Ctrl+] to detach without stopping session)"
    echo "Press Ctrl+C to stop server"
    echo ""

    # Handle shutdown
    trap 'echo ""; echo "Shutting down..."; kill $SERVER_PID 2>/dev/null; [ -n "$NGROK_PID" ] && kill $NGROK_PID 2>/dev/null; rm -f "$TELECLAUDE_HOME/.teleclaude.pid" "$TELECLAUDE_HOME/.teleclaude.url"; exit 0' INT TERM

    wait $SERVER_PID
}

cmd_attach() {
    local target="$1"

    check_venv
    source "$TELECLAUDE_HOME/venv/bin/activate"

    cd "$TELECLAUDE_HOME"

    # If URL provided (http/https/ws/wss), connect to remote
    if [[ "$target" =~ ^https?:// ]] || [[ "$target" =~ ^wss?:// ]]; then
        # Convert http(s) to ws(s) if needed
        local ws_url="$target"
        ws_url="${ws_url/https:\/\//wss://}"
        ws_url="${ws_url/http:\/\//ws://}"

        # Add /ws/terminal if not present
        if [[ ! "$ws_url" =~ /ws/terminal$ ]]; then
            ws_url="${ws_url%/}/ws/terminal"
        fi

        echo "Attaching to remote session..."
        echo "Press Ctrl+] to detach (session keeps running)"
        echo ""
        python -m server.attach --url "$ws_url"
    else
        # Local connection
        if ! curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
            echo "Error: TeleClaude server is not running"
            echo "Start it with: teleclaude start"
            exit 1
        fi

        echo "Attaching to session at localhost:$PORT..."
        echo "Press Ctrl+] to detach (session keeps running)"
        echo ""
        python -m server.attach --port $PORT
    fi
}

cmd_stop() {
    echo "Stopping TeleClaude..."

    if [ -f "$TELECLAUDE_HOME/.teleclaude.pid" ]; then
        PID=$(cat "$TELECLAUDE_HOME/.teleclaude.pid")
        kill $PID 2>/dev/null && echo "Server stopped"
        rm -f "$TELECLAUDE_HOME/.teleclaude.pid"
    fi

    pkill -f "uvicorn server.main:app.*--port $PORT" 2>/dev/null
    pkill -f "ngrok http $PORT" 2>/dev/null
    rm -f "$TELECLAUDE_HOME/.teleclaude.url"

    echo "Done"
}

cmd_status() {
    if curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
        echo "TeleClaude is running"
        curl -s "http://localhost:$PORT/api/status" | python3 -c "
import sys, json
data = json.load(sys.stdin)
print(f\"  Working dir: {data.get('working_dir', 'unknown')}\")
print(f\"  Clients: {data.get('connected_clients', 0)}\")
print(f\"  Local: http://localhost:$PORT\")
"
        if [ -f "$TELECLAUDE_HOME/.teleclaude.url" ]; then
            echo "  Remote: $(cat "$TELECLAUDE_HOME/.teleclaude.url")"
        fi
    else
        echo "TeleClaude is not running"
        echo "Start it with: teleclaude start"
    fi
}

cmd_url() {
    if [ -f "$TELECLAUDE_HOME/.teleclaude.url" ]; then
        cat "$TELECLAUDE_HOME/.teleclaude.url"
    else
        if curl -s "http://localhost:$PORT/api/status" > /dev/null 2>&1; then
            echo "http://localhost:$PORT"
            echo ""
            echo "No ngrok tunnel. Start ngrok for remote access."
        else
            echo "TeleClaude is not running"
        fi
    fi
}

# Parse arguments
case "${1:-start}" in
    start)
        cmd_start "$2"
        ;;
    attach|a)
        cmd_attach "$2"
        ;;
    stop)
        cmd_stop
        ;;
    status|s)
        cmd_status
        ;;
    url|u)
        cmd_url
        ;;
    -h|--help|help)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
